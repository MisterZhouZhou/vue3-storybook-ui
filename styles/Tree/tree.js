"use strict";const s=require("vue"),w=require("lodash"),T=require("./types.js"),I=require("./treeNode.js"),x=require("./util.js");require("./index.scss.js");const E=s.defineComponent({name:"MTree",props:T.TreeProps(),emits:["select-change","check-change"],setup(h,{slots:y,emit:o,expose:k}){const a=s.ref([]),i=s.ref(!1),f=s.ref(""),g=s.ref([]),C=(e,l)=>{l&&(g.value[e]=l)};k({getSelectedNode:()=>a.value.find(e=>e.selected),getCheckedNodes:()=>a.value.filter(e=>e.checked),getHalfCheckedNodes:()=>g.value.filter(e=>e.halfChecked()).map(e=>e.node)});function p(e){const l=[],c=(d,n=0,u=null)=>d.map(r=>{const t={...r,level:n,loading:!1,disabled:r.disabled||!1,expanded:r.expanded||!1,selected:r.selected||!1,checked:r.checked||(u==null?void 0:u.checked)||!1,hasChildren:r.hasChildren||!1,parentKey:(u==null?void 0:u.nodeKey)||null,children:r.children||[]};return t.selected&&(f.value=t.nodeKey),l.push(t),t.children.length&&r.expanded&&(t.children=c(t.children,n+1,t)),t});return e.length&&c(e),l}const K=e=>{const l=[],c=d=>{d.children.length&&d.children.forEach(n=>{l.push(n.nodeKey),n.expanded&&(n.expanded=!1,c(n))})};c(e),l.length&&(a.value=a.value.filter(d=>!l.includes(d.nodeKey)))},v=(e,l)=>{const c=l!=null&&l.length?l:w.cloneDeep(e.children);e.children=c.map(n=>({...n,level:n.level||e.level+1,loading:!1,disabled:n.disabled||!1,expanded:n.expanded||!1,selected:n.selected||!1,checked:n.checked||!1,hasChildren:n.hasChildren||!1,parentKey:e.nodeKey||null,children:n.children||[]}));const d=a.value.findIndex(n=>n.nodeKey===e.nodeKey);d>-1&&a.value.splice(d+1,0,...e.children)},N=e=>{i.value||(e.expanded=!e.expanded,e.expanded?e.children.length?v(e):h.lazyLoad&&e.hasChildren?(e.loading=!0,i.value=!0,h.lazyLoad(e,l=>{l.length&&v(e,l),e.loading=!1,i.value=!1})):e.expanded=!e.expanded:K(e))},S=e=>{if(e.selected=!e.selected,f.value===e.nodeKey)f.value="";else{const l=a.value.findIndex(c=>c.nodeKey===f.value);l>-1&&(a.value[l].selected=!1),f.value=e.nodeKey}o("select-change",e)},b=([e,l])=>{l.checked=e,h.checkStrictly||(x.updateDownWards(e,l),x.updateUpwards(l,a.value)),o("check-change",l)};s.watch(()=>h.source,e=>{a.value=p(e)},{immediate:!0});const q=()=>a.value.map((e,l)=>s.createVNode(I,{ref:C.bind(null,l),key:e.nodeKey,node:e,render:h.render,iconSlot:y.icon,showCheckbox:h.showCheckbox,checkStrictly:h.checkStrictly,onToggleExpand:N,onSelectChange:S,onCheckChange:b},null));return()=>s.createVNode("div",{class:"m-tree-wrap"},[s.createVNode("div",{class:"m-tree"},[q()])])}});module.exports=E;
